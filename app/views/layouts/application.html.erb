<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "anatomical." %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <!-- iOS PWA Enhanced Support -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="anatomical.">

    <!-- Enhanced PWA meta -->
    <meta name="theme-color" content="#dc3545">
    <meta name="msapplication-TileColor" content="#dc3545">
    <meta name="description" content="Track your workouts, manage recovery, and beat your benchmarks">

    <!-- ✅ Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">

    <!-- Favicon and Touch Icons -->
    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">

    <!-- iOS Icons for different devices -->
    <link rel="apple-touch-icon" href="/icon.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icon-76x76.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icon-120x120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icon-180x180.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <%= stylesheet_link_tag "application",
        "animations/typography",
        "animations/loading-screen",
        "themes/dark-theme",
        "components/buttons",
        "components/badge-editor",
        "components/forms",
        "components/navbar",
        "components/alerts",
        "components/dropdowns",
        "components/custom-split-builder",
        "pages/workout-logs",
        "data-turbo-track": "reload" %>

    <!-- ✅ JavaScript (Importmap + Turbo + Stimulus) -->
    <%= javascript_importmap_tags %>

    <!-- ✅ Bootstrap JS (for dropdowns, navbar toggler, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/service-worker.js')
            .then(function(registration) {
              console.log('ServiceWorker registration successful');
            })
            .catch(function(registrationError) {
              console.log('ServiceWorker registration failed: ', registrationError);
            });
        });
      }
    </script>

    <!-- iOS PWA Install Prompt -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent)
        const isStandalone = window.navigator.standalone
        const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent)

        if (isIOS && !isStandalone && isSafari) {
          const dismissed = sessionStorage.getItem('ios-install-dismissed')

          if (!dismissed) {
            setTimeout(showIOSInstallPrompt, 3000) // Show after 3 seconds
          }
        }
      })

      function showIOSInstallPrompt() {
        const promptHTML = `
          <div id="ios-install-prompt" style="
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: var(--surface-primary);
            border: 1px solid #dc3545;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            z-index: 9999;
            font-family: var(--font-primary);
            color: var(--text-primary);
            animation: slideUp 0.3s ease-out;
          ">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <img src="/icon.png" style="width: 48px; height: 48px; border-radius: 8px;">
              <div style="flex: 1;">
                <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: var(--text-primary);">Add anatomical. to Home Screen</h4>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--text-secondary);">
                  Get the full app experience
                </p>
              </div>
              <button id="ios-install-close" style="
                background: none;
                border: none;
                color: var(--text-secondary);
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0.25rem;
              ">&times;</button>
            </div>

            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-muted); font-size: 0.875rem; color: var(--text-secondary);">
              1. Tap the <strong style="color: #dc3545;">Share</strong> button ⬆️<br>
              2. Select <strong style="color: #dc3545;">"Add to Home Screen"</strong>
            </div>
          </div>

          <style>
            @keyframes slideUp {
              from { transform: translateY(100%); opacity: 0; }
              to { transform: translateY(0); opacity: 1; }
            }
          </style>
        `

        document.body.insertAdjacentHTML('beforeend', promptHTML)

        document.getElementById('ios-install-close').addEventListener('click', function() {
          const prompt = document.getElementById('ios-install-prompt')
          prompt.style.animation = 'slideUp 0.3s ease-out reverse'
          setTimeout(() => prompt.remove(), 300)
          sessionStorage.setItem('ios-install-dismissed', 'true')
        })

        // Auto-hide after 8 seconds
        setTimeout(() => {
          const prompt = document.getElementById('ios-install-prompt')
          if (prompt) {
            prompt.style.animation = 'slideUp 0.3s ease-out reverse'
            setTimeout(() => prompt.remove(), 300)
          }
        }, 8000)
      }
    </script>
  </head>

  <body>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-figures">
      <div class="loading-figure green">
        <%= image_tag "logo-animation/green-man.svg", alt: "Green figure", class: "w-100 h-100" %>
      </div>
      <div class="loading-figure amber">
        <%= image_tag "logo-animation/amber-man.svg", alt: "Amber figure", class: "w-100 h-100" %>
      </div>
      <div class="loading-figure red">
        <%= image_tag "logo-animation/red-man.svg", alt: "Red figure", class: "w-100 h-100" %>
      </div>
    </div>
    <div class="loading-title">
      <%= image_tag "logo-animation/anatomical-title.svg", alt: "anatomical.", class: "w-100 h-100" %>
    </div>
  </div>

 <script>
    // Only show loading screen on initial page load, not on Turbo navigation
    if (performance.navigation.type === 0) { // 0 = navigate (first load)
      document.addEventListener('DOMContentLoaded', function() {
        // Debug what SVGs are actually loading
        const figures = document.querySelectorAll('.loading-figure img');
        const title = document.querySelector('.loading-title img');

        console.log('=== LOADING SCREEN DEBUG ===');
        console.log('Total figures found:', figures.length);

        figures.forEach((img, index) => {
          console.log(`Figure ${index}:`, img.src, 'loaded:', img.complete);
          img.onload = () => console.log(`✅ Figure ${index} loaded:`, img.src);
          img.onerror = () => console.log(`❌ Figure ${index} failed:`, img.src);
        });

        if (title) {
          console.log('Title:', title.src, 'loaded:', title.complete);
          title.onload = () => console.log('✅ Title loaded:', title.src);
          title.onerror = () => console.log('❌ Title failed:', title.src);
        }

        // Multiple PWA detection methods
        const isPWA = navigator.standalone ||
                      window.matchMedia('(display-mode: standalone)').matches ||
                      window.matchMedia('(display-mode: fullscreen)').matches ||
                      document.referrer.includes('android-app://');

        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // Aggressive timing for mobile PWA
        let loadingDuration = 3000;
        if (isPWA && isMobile) {
          loadingDuration = 6000; // Much longer for mobile PWA
        } else if (isPWA) {
          loadingDuration = 4500; // Medium for desktop PWA
        } else if (isMobile) {
          loadingDuration = 4000; // Medium for mobile browser
        }

        console.log('Loading duration:', loadingDuration, 'isPWA:', isPWA, 'isMobile:', isMobile);

        setTimeout(function() {
          const overlay = document.getElementById('loadingOverlay');
          if (overlay) {
            overlay.classList.add('completed');
            setTimeout(() => overlay.remove(), 500);
          }
        }, loadingDuration);
      });
    } else {
      // Hide loading screen immediately on subsequent navigations
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'none';
    }
  </script>

    <!-- ✅ Navbar -->
    <%= render "shared/navbar" %>

    <!-- ✅ Flash Messages -->
    <div class="container mt-3">
      <% if notice %>
        <div class="alert alert-info alert-dismissible fade show" role="alert">
          <%= notice %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% end %>

      <% if alert %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= alert %>
          <% unless user_signed_in? %>
            <%= link_to "Sign In", new_user_session_path, class: "btn btn-sm btn-outline-light ms-3" %>
          <% end %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% end %>
    </div>

    <!-- ✅ Main Content -->
    <div class="container">
      <%= yield %>
    </div>

    <!-- ✅ Chart.js for workout trends, recovery forecasts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  </body>

</html>
